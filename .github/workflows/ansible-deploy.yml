name: Ansible-Deploy
on:
  push:
    branches:
      - master  #Ð˜Ð—ÐœÐ•ÐÐ˜Ð¢Ð¬ ÐÐ ÐœÐÐ¡Ð¢Ð•Ð 
    paths:
      - 'ansible/**'  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð¿Ð°Ð¿ÐºÐµ ansible/
  workflow_dispatch:
  workflow_run:
    workflows: ["Terraform-deploy"] 
    types:
      - completed
  repository_dispatch:  # ðŸ‘ˆ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€ Ð¸Ð· Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
    types: [external-trigger]

jobs:
  ansible:
    name: Ansible Deploy
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ vars.AWS_REGION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: Install Python dependencies
        run: |
          sudo apt update && sudo apt install -y python3-pip python3-venv
          pip install --upgrade pip
          pip install ansible boto3 botocore

          
      - name: Debug AWS Access
        run: |
          aws sts get-caller-identity
          echo "AWS_REGION: $AWS_REGION"


      - name: Run Ansible Playbook with SSH key
        working-directory: ./ansible
        env:
          instance_test_key: ${{ secrets.instance_test_key }}
          ansible_user: ${{ vars.ANSIBLE_USER }}
        run: |
          echo "$instance_test_key" > ./instance_test_key.pem
          chmod 600 ./instance_test_key.pem
          ansible-playbook -i aws_ec2.yaml playbook.yaml --private-key ./instance_test_key.pem -u ${ansible_user}

